function Signer(c){var d=this,f={},h=0,e=-1,g=null,b=new BaseCrypto(c);d.initialized=false;c.signatureRequired=typeof c.signatureRequired=="undefined"?true:c.signatureRequired;this.init=function(){if(!d.initialized){d.initialized=d.populateCertificatesSelectList()}var i=c.expirationMessageContainer||"expirationField";$(c.certList).bind("change keypress",function(){var m=$("div[name='"+i+"']").empty();var k=$(this).find("option:selected").attr("expirationDate");var j=d.daysFromNow(k);if(j>=0&&j<=7){var l=($("#expirationTextTemplate").val());if(l){l=l.replace("{}",j);m.text(l)}}});$(c.certList).change();return d.initialized};this.isInitialized=function(){return d.initialized};this.getLastError=function(){return g?g:b.getLastError()};this.makeSnapshotAndSubmit=function(){if(d.makeSnapshot()){$(c.formSelector).submit()}return false};this.makeSnapshotWithOptions=function(m,j,l){var o=c.formSelector,k=c.signatureInput,n=c.fieldsToSerialize;c.formSelector=m;c.signatureInput=j;c.fieldsToSerialize=l;var i=d.makeSnapshot();c.formSelector=o;c.signatureInput=k;c.fieldsToSerialize=n;return i};this.makeSnapshot=function(){var l=false;g=null;var i=a();if((i==h||i==e||i==null)&&!c.signatureRequired){$(c.signatureInput).val("");l=true}else{var j=$(c.formSelector);if(j){$(c.signatureInput).val("");f={};if(c.fieldsToSerialize){$.each(c.fieldsToSerialize,function(n,q){var p=j.find('[name="'+q+'"]');var o=null;if(p.length==1){o=p.val()}else{for(var m=0;m<p.length;m++){if(p[m].type=="radio"&&p[m].checked){o=$(p[m]).val()}}}d.addFieldToTree({name:q,value:o})})}else{$.each(j.serializeArray(),function(m,n){d.addFieldToTree(n)})}d.addFieldToTree({name:"dateSigning",value:d.getTime()});var k=d.signXML('<?xml version="1.0" encoding="UTF-16LE"?><data>'+d.objectToXml(f)+"</data>");if(k!=false){$(c.signatureInput).val(k);l=true}else{l=false;if(b.getLastError()){g=b.getLastError()}else{g="SIGN_ERROR"}console.log("Error creating signature. SignedData is false. Last error is "+g)}}}return l};this.getTime=function(){if(SERVER_TIME!==undefined){return SERVER_TIME.getDateTimeToString()}else{var j=function(l){var k=parseInt(l);if(k<=9&&k>=0){return"0"+l}else{return""+l}};var i=new Date();return j(i.getDate())+"."+j((parseInt(i.getMonth())+1).toString())+"."+j(i.getFullYear())+" "+j(i.getHours())+":"+j(i.getMinutes())+":"+j(i.getSeconds())}};this.signObject=function(i){return d.signXML('<?xml version="1.0" encoding="UTF-16LE"?><data>'+d.objectToXml(i)+"</data>")};this.signXML=function(j){var k=false,i="";if(c.improvedSignatureChkbx){k=$(c.improvedSignatureChkbx).val();i=$(c.tspAddressInput).val()}return b.signData(a(),k,j,i)};this.getCertificatesList=function(){return b.getCertificateList()};this.populateCertificatesSelectList=function(){var j,n=c.signatureRequired,l=b.isPluginInstalled();g=null;if(n&&!l){j=false;g="NO_PLUGIN"}else{var k=[];if(!n){k.push(new Option(SIGNER_DO_NOT_SIGN,h))}if(c.showSelectEDS){k.push(new Option(SIGNER_SELECT_EDS,e))}var i=[];if(l){$(c.certList).empty();try{var o=b.getCertificateList();$.each(o,function(q,r){var s=new Option(r.subjectName,r.thumbprint);var p=Date.parse(r.expirationDate);s.setAttribute("expirationDate",p);i.push(s)})}catch(m){i=[]}}k=k.concat(i);if(k.length==0){j=false;g="NO_CERTS"}else{$(c.certList).append(k);j=true}}return j};this.addFieldToTree=function(m){if(m.value){var j=m.name.split(".");if(j){var l=f;for(var k=0;k<j.length;k++){if(!l[j[k]]){if(k==j.length-1){l[j[k]]={name:(c.fieldNames&&c.fieldNames[m.name])?c.fieldNames[m.name]:m.name,value:(c.enumLables&&c.enumLables[m.value])?c.enumLables[m.value]:m.value,valueObject:true}}else{l[j[k]]={}}}else{l=l[j[k]]}}}}};this.objectToXml=function(k){var j="";if(k){for(var i in k){if(k[i]&&k[i].valueObject){j+="<"+i+' class="valueObject"><name><![CDATA['+k[i].name+"]]></name><value><![CDATA["+k[i].value+"]]></value></"+i+">"}else{j+=d.objectToXml(k[i])}}}return j};this.daysFromNow=function(k){if(!k){return -1}var j=new Date();var i=1000*60*60*24;var l=(k-j.getTime())/i;return Math.round(l)};function a(){var i=d.getRememberedCertificate();return i?i:$(c.certList).val()}this.getRememberedCertificate=function(){var i=null;if(c.rememberCertStorageId){var j=sessionStorage.getItem(c.rememberCertStorageId);if(j){i=JSON.parse(j).certId}}return i};this.removeSelectEdsOption=function(){$(c.certList).find('option[value="'+e+'"]').remove()}};